// Helper: Only waits as long as necessary for an element to appear
const waitForElement = (selector, timeout = 5000) => {
    return new Promise((resolve) => {
        const startTime = Date.now();
        const timer = setInterval(() => {
            const el = document.querySelector(selector);
            if (el || (Date.now() - startTime) > timeout) {
                clearInterval(timer);
                resolve(el);
            }
        }, 100); // Check every 100ms
    });
};

// SPECIAL FUNCTION: Forces React to recognize the new value
function setReactValue(input, value) {
    const lastValue = input.value;
    input.value = value;
    const event = new Event('input', { bubbles: true });
    const tracker = input._valueTracker;
    if (tracker) { tracker.setValue(lastValue); }
    input.dispatchEvent(event);
    input.dispatchEvent(new Event('change', { bubbles: true }));
}

async function startLoop() {
    console.log("--- Turbo Script Started ---");
    window.keepRunning = true; 

    while (window.keepRunning) {
        
        // --- STEP 1: Find and Click "Edit" ---
        const editButton = document.querySelector('button[title="Edit"]');
        if (!editButton) {
            console.log("Waiting for 'Edit' button to appear...");
            await new Promise(r => setTimeout(r, 1000));
            continue; 
        }
        editButton.click();

        // --- STEP 2: Wait for Toggle Button (Smart Wait) ---
        const exclusiveBtn = await waitForElement('button.kLhpgF.EmRZoj.SoTRex.YfVnml');
        
        if (exclusiveBtn) {
            // Click to toggle if it's currently OFF
            if (exclusiveBtn.getAttribute('aria-pressed') === 'false') {
                exclusiveBtn.click();
                // Wait briefly for price inputs to slide into view
                await new Promise(r => setTimeout(r, 500)); 
            }

            // --- STEP 3: Set Prices (Smart Wait) ---
            const purchaseInput = await waitForElement('input[name="purchase_price"]');
            if (purchaseInput) {
                setReactValue(purchaseInput, "2");
            }

            const offerInput = await waitForElement('input[name="offer"]');
            if (offerInput) {
                setReactValue(offerInput, "1");
            }
            
            // Minimal pause to ensure site registers input before clicking submit
            await new Promise(r => setTimeout(r, 300));
        }

        // --- STEP 4: Submit ---
        const submitButton = document.querySelector('button.VwjxrB');
        if (submitButton) {
            submitButton.click();
            console.log("Cycle Complete.");
        }

        // --- STEP 5: Cycle Delay ---
        // How long to wait before clicking "Edit" on the NEXT item?
        await new Promise(r => setTimeout(r, 2000)); 
    }
    
    console.log("--- Script Stopped ---");
}

startLoop();
